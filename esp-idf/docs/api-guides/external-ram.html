

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Support for external RAM &mdash; ESP-IDF Programming Guide v3.0-dev-806-gde750e9 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="ESP-IDF Programming Guide v3.0-dev-806-gde750e9 documentation" href="../index.html"/>
        <link rel="up" title="API Guides" href="index.html"/>
        <link rel="next" title="Contributions Guide" href="../contribute/index.html"/>
        <link rel="prev" title="Wi-Fi Driver" href="wifi.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ESP-IDF Programming Guide
          

          
          </a>

          
            
            
              <div class="version">
                v3.0-dev-806-gde750e9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">H/W Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="general-notes.html">General Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-system.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="deep-sleep-stub.html">Deep Sleep Wake Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_dump.html">ESP32 Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/flash-encryption.html">Flash Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="freertos-smp.html">FreeRTOS SMP Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="hlinterrupts.html">High Level Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="jtag-debugging/index.html">JTAG Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="partition-tables.html">Partition Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/secure-boot.html">Secure Boot</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp.html">ULP Coprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests.html">Unit Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="app_trace.html">Application Level Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="romconsole.html">ROM debug console</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">WiFi Driver</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="external-ram.html#">External SPI-connected RAM</a><ul>
<li class="toctree-l3"><a class="reference internal" href="external-ram.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="external-ram.html#hardware">Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="external-ram.html#software">Software</a><ul>
<li class="toctree-l4"><a class="reference internal" href="external-ram.html#restrictions">Restrictions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="external-ram.html#chip-revisions">Chip revisions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="external-ram.html#esp32-rev-v0">ESP32 rev v0</a></li>
<li class="toctree-l4"><a class="reference internal" href="external-ram.html#esp32-rev-v1">ESP32 rev v1</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ESP-IDF Programming Guide</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">API Guides</a> &raquo;</li>
        
      <li>Support for external RAM</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api-guides/external-ram.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="support-for-external-ram">
<h1>Support for external RAM<a class="headerlink" href="external-ram.html#support-for-external-ram" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="external-ram.html#introduction" title="Permalink to this headline">¶</a></h2>
<p>The ESP32 has a few hundred KiB of internal RAM, residing on the same die as the rest of the ESP32. For some purposes, this is insufficient,
and therefore the ESP32 incorporates the ability to also use up to 4MiB of external SPI RAM memory as memory. The external memory is incorporated
in the memory map and is, within certain restrictions, usable in the same way internal data RAM is.</p>
</div>
<div class="section" id="hardware">
<h2>Hardware<a class="headerlink" href="external-ram.html#hardware" title="Permalink to this headline">¶</a></h2>
<p>The ESP32 supports SPI (P)SRAM connected in parallel with the SPI flash chip. While the ESP32 is capable of supporting several types
of RAM chips, the ESP32 SDK at the moment only supports the ESP-PSRAM32 chip.</p>
<p>The ESP-PSRAM32 chip is an 1.8V device, and can only be used in parallel with an 1.8V flash part. Make sure to either set the MTDI
pin to a high signal level on bootup, or program the fuses in the ESP32 to always use a VDD_SIO level of 1.8V. Not doing this risks
damaging the PSRAM and/or flash chip.</p>
<dl class="docutils">
<dt>To connect the ESP-PSRAM chip to the ESP32D0W*, connect the following signals:</dt>
<dd><ul class="first last simple">
<li>PSRAM /CE (pin 1) - ESP32 GPIO 16</li>
<li>PSRAM SO (pin 2) - flash DO</li>
<li>PSRAM SIO[2] (pin 3) - flash WP</li>
<li>PSRAM SI (pin 5) - flash DI</li>
<li>PSRAM SCLK (pin 6) - ESP32 GPIO 17</li>
<li>PSRAM SIO[3] (pin 7) - flash HOLD</li>
<li>PSRAM Vcc (pin 8) - ESP32 VCC_SDIO</li>
</ul>
</dd>
</dl>
<p>Connections for the ESP32D2W* chips are TBD.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Espressif sells an ESP-WROVER module which contains an ESP32, 1.8V flash and the ESP-PSRAM32 integrated in a module, ready for inclusion
on an end product PCB.</p>
</div>
</div>
<div class="section" id="software">
<h2>Software<a class="headerlink" href="external-ram.html#software" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>ESP-IDF fully supports integrating external memory use into your applications. ESP-IDF can be configured to handle external RAM in several ways:</dt>
<dd><ul class="first last simple">
<li>Only initialize RAM. This allows the application to manually place data here by dereferencing pointers pointed at the external RAM memory
region (0x3F800000 and up).</li>
<li>Initialize RAM and add it to the capability allocator. This allows a program to specifically allocate a chunk of external RAM using
<code class="docutils literal"><span class="pre">heap_caps_malloc(size,</span> <span class="pre">MALLOC_CAP_SPIRAM)</span></code>. This memory can be used and subsequently freed using a normal <code class="docutils literal"><span class="pre">free()</span></code> call.</li>
<li>Initialize RAM, add it to the capability allocator and add memory to the pool of RAM that can be returned by <code class="docutils literal"><span class="pre">malloc()</span></code>. This allows
any application to use the external RAM without having to rewrite the code to use <code class="docutils literal"><span class="pre">heap_caps_malloc</span></code>.</li>
</ul>
</dd>
</dl>
<p>All these options can be selected from the menuconfig menu.</p>
<div class="section" id="restrictions">
<h3>Restrictions<a class="headerlink" href="external-ram.html#restrictions" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>The use of external RAM has a few restrictions:</dt>
<dd><ul class="first last simple">
<li>When disabling flash cache (for example, because the flash is being written to), the external RAM also becomes inaccessible; any reads from or
writes to it will lead to an illegal cache access exception. This is also the reason that ESP-IDF will never allocate a tasks stack in external
RAM.</li>
<li>External RAM cannot be used as a place to store DMA transaction descriptors or as a buffer for a DMA transfer to read from or write into. Any
buffers that will be used in combination with DMA must be allocated using <code class="docutils literal"><span class="pre">heap_caps_malloc(size,</span> <span class="pre">MALLOC_CAP_DMA)</span></code> (and can be freed using a
standard <code class="docutils literal"><span class="pre">free()</span></code> call.)</li>
<li>External RAM uses the same cache region as the external flash. This means that often accessed variables in external RAM can be read and
modified almost as quickly as in internal ram. However, when accessing large chunks of data (&gt;32K), the cache can be insufficient and speeds
will fall back to the access speed of the external RAM. Moreover, accessing large chunks of data can &#8216;push out&#8217; cached flash, possibly making
execution of code afterwards slower.</li>
<li>External RAM cannot be used as task stack memory; because of this, xTaskCreate and similar functions will always allocate internal memory
for stack and task TCBs and xTaskCreateStatic-type functions will check if the buffers passed are internal. However, for tasks not calling
on code in ROM in any way, directly or indirectly, the menuconfig option <a class="reference internal" href="../api-reference/kconfig.html#config-spiram-allow-stack-external-memory"><span class="std std-ref">SPIRAM_ALLOW_STACK_EXTERNAL_MEMORY</span></a> will eliminate
the check in xTaskCreateStatic, allowing task stack in external RAM. Using this is not advised, however.</li>
</ul>
</dd>
</dl>
<p>Because there are a fair few situations that have a specific need for internal memory, but it is also possible to use malloc() to exhaust
internal memory, there is a pool reserved specifically for requests that cannot be resolved from external memory; allocating task
stack, DMA buffers and memory that stays accessible when cache is disabled is drawn from this pool. The size of this pool is configurable
in menuconfig.</p>
</div>
</div>
<div class="section" id="chip-revisions">
<h2>Chip revisions<a class="headerlink" href="external-ram.html#chip-revisions" title="Permalink to this headline">¶</a></h2>
<p>There are some issues with certain revisions of the ESP32 that have repercussions for use with external RAM. These are documented in the ESP32
<a class="reference external" href="https://www.espressif.com/sites/default/files/documentation/eco_and_workarounds_for_bugs_in_esp32_en.pdf">ECO</a> document. In particular, ESP-IDF handles the bugs mentioned in the following ways:</p>
<div class="section" id="esp32-rev-v0">
<h3>ESP32 rev v0<a class="headerlink" href="external-ram.html#esp32-rev-v0" title="Permalink to this headline">¶</a></h3>
<p>ESP-IDF has no workaround for the bugs in this revision of silicon, and it cannot be used to map external PSRAM into the ESP32s main memory map.</p>
</div>
<div class="section" id="esp32-rev-v1">
<h3>ESP32 rev v1<a class="headerlink" href="external-ram.html#esp32-rev-v1" title="Permalink to this headline">¶</a></h3>
<p>The bugs in this silicon revision introduce a hazard when certain sequences of machine instructions operate on external memory locations (ESP32 ECO 3.2).
To work around this, the gcc compiler to compile ESP-IDF has been expanded with a flag: <code class="docutils literal"><span class="pre">-mfix-esp32-psram-cache-issue</span></code>. With this flag passed to gcc
on the command line, the compiler works around these sequences and only outputs code that can safely be executed.</p>
<p>In ESP-IDF, this flag is enabled when you select <a class="reference internal" href="../api-reference/kconfig.html#config-spiram-cache-workaround"><span class="std std-ref">SPIRAM_CACHE_WORKAROUND</span></a>. ESP-IDF also takes other measures to make
sure no combination of PSRAM access plus the offending instruction sets are used: it links to a version of Newlib recompiled with the gcc flag, doesn&#8217;t use
some ROM functions and allocates static memory for the WiFi stack.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../contribute/index.html" class="btn btn-neutral float-right" title="Contributions Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="wifi.html" class="btn btn-neutral" title="Wi-Fi Driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 - 2017, Espressif.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v3.0-dev-806-gde750e9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>