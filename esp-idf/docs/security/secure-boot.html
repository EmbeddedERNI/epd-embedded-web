

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Secure Boot &mdash; ESP-IDF Programming Guide v3.0-dev-806-gde750e9 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="ESP-IDF Programming Guide v3.0-dev-806-gde750e9 documentation" href="../index.html"/>
        <link rel="up" title="API Guides" href="../api-guides/index.html"/>
        <link rel="next" title="ULP coprocessor programming" href="../api-guides/ulp.html"/>
        <link rel="prev" title="Partition Tables" href="../api-guides/partition-tables.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ESP-IDF Programming Guide
          

          
          </a>

          
            
            
              <div class="version">
                v3.0-dev-806-gde750e9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">H/W Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../api-guides/index.html">API Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api-guides/general-notes.html">General Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/build-system.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/deep-sleep-stub.html">Deep Sleep Wake Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/core_dump.html">ESP32 Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="flash-encryption.html">Flash Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/freertos-smp.html">FreeRTOS SMP Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/hlinterrupts.html">High Level Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/jtag-debugging/index.html">JTAG Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/partition-tables.html">Partition Tables</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="secure-boot.html#">Secure Boot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#secure-boot-process-overview">Secure Boot Process Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#keys">Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#how-to-enable-secure-boot">How To Enable Secure Boot</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#re-flashable-software-bootloader">Re-Flashable Software Bootloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#generating-secure-boot-signing-key">Generating Secure Boot Signing Key</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#remote-signing-of-images">Remote Signing of Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#secure-boot-best-practices">Secure Boot Best Practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="secure-boot.html#technical-details">Technical Details</a><ul>
<li class="toctree-l4"><a class="reference internal" href="secure-boot.html#secure-boot-hardware-support">Secure Boot Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="secure-boot.html#secure-bootloader-digest-algorithm">Secure Bootloader Digest Algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="secure-boot.html#image-signing-algorithm">Image Signing Algorithm</a></li>
<li class="toctree-l4"><a class="reference internal" href="secure-boot.html#manual-commands">Manual Commands</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/ulp.html">ULP Coprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/unit-tests.html">Unit Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/app_trace.html">Application Level Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/console.html">Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/romconsole.html">ROM debug console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/wifi.html">WiFi Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api-guides/external-ram.html">External SPI-connected RAM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ESP-IDF Programming Guide</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../api-guides/index.html">API Guides</a> &raquo;</li>
        
      <li>Secure Boot</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/security/secure-boot.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="secure-boot">
<h1>Secure Boot<a class="headerlink" href="secure-boot.html#secure-boot" title="Permalink to this headline">¶</a></h1>
<p>Secure Boot is a feature for ensuring only your code can run on the chip. Data loaded from flash is verified on each reset.</p>
<p>Secure Boot is separate from the <a class="reference internal" href="flash-encryption.html"><span class="doc">Flash Encryption</span></a> feature, and you can use secure boot without encrypting the flash contents. However we recommend using both features together for a secure environment.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Enabling secure boot limits your options for further updates of your ESP32. Make sure to read this document throughly and understand the implications of enabling secure boot.</p>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="secure-boot.html#background" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Most data is stored in flash. Flash access does not need to be protected from physical access in order for secure boot to function, because critical data is stored (non-software-accessible) in Efuses internal to the chip.</li>
<li>Efuses are used to store the secure bootloader key (in efuse BLOCK2), and also a single Efuse bit (ABS_DONE_0) is burned (written to 1) to permanently enable secure boot on the chip.  For more details about efuse, see Chapter 11 &#8220;eFuse Controller&#8221; in the Technical Referecnce Manual.</li>
<li>To understand the secure boot process, first familiarise yourself with the standard <a class="reference internal" href="../api-guides/general-notes.html"><span class="doc">ESP-IDF boot process</span></a>.</li>
<li>Both stages of the boot process (initial software bootloader load, and subsequent partition &amp; app loading) are verified by the secure boot process, in a &#8220;chain of trust&#8221; relationship.</li>
</ul>
</div>
<div class="section" id="secure-boot-process-overview">
<h2>Secure Boot Process Overview<a class="headerlink" href="secure-boot.html#secure-boot-process-overview" title="Permalink to this headline">¶</a></h2>
<p>This is a high level overview of the secure boot process. Step by step instructions are supplied under <a class="reference internal" href="secure-boot.html#secure-boot-howto"><span class="std std-ref">How To Enable Secure Boot</span></a>. Further in-depth details are supplied under <a class="reference internal" href="secure-boot.html#secure-boot-technical-details"><span class="std std-ref">Technical Details</span></a>:</p>
<ol class="arabic simple">
<li>The options to enable secure boot are provided in the <code class="docutils literal"><span class="pre">make</span> <span class="pre">menuconfig</span></code> hierarchy, under &#8220;Secure Boot Configuration&#8221;.</li>
<li>Secure Boot defaults to signing images and partition table data during the build process. The &#8220;Secure boot private signing key&#8221; config item is a file path to a ECDSA public/private key pair in a PEM format file.</li>
<li>The software bootloader image is built by esp-idf with secure boot support enabled and the public key (signature verification) portion of the secure boot signing key compiled in. This software bootloader image is flashed at offset 0x1000.</li>
<li>On first boot, the software bootloader follows the following process to enable secure boot:<ul>
<li>Hardware secure boot support generates a device secure bootloader key (generated via hardware RNG, then stored read/write protected in efuse), and a secure digest. The digest is derived from the key, an IV, and the bootloader image contents.</li>
<li>The secure digest is flashed at offset 0x0 in the flash.</li>
<li>Depending on Secure Boot Configuration, efuses are burned to disable JTAG and the ROM BASIC interpreter (it is strongly recommended these options are turned on.)</li>
<li>Bootloader permanently enables secure boot by burning the ABS_DONE_0 efuse. The software bootloader then becomes protected (the chip will only boot a bootloader image if the digest matches.)</li>
</ul>
</li>
<li>On subsequent boots the ROM bootloader sees that the secure boot efuse is burned, reads the saved digest at 0x0 and uses hardware secure boot support to compare it with a newly calculated digest. If the digest does not match then booting will not continue. The digest and comparison are performed entirely by hardware, and the calculated digest is not readable by software. For technical details see <a class="reference internal" href="secure-boot.html#secure-boot-hardware-support"><span class="std std-ref">Secure Boot Hardware Support</span></a>.</li>
<li>When running in secure boot mode, the software bootloader uses the secure boot signing key (the public key of which is embedded in the bootloader itself, and therefore validated as part of the bootloader) to verify the signature appended to all subsequent partition tables and app images before they are booted.</li>
</ol>
</div>
<div class="section" id="keys">
<h2>Keys<a class="headerlink" href="secure-boot.html#keys" title="Permalink to this headline">¶</a></h2>
<p>The following keys are used by the secure boot process:</p>
<ul class="simple">
<li>&#8220;secure bootloader key&#8221; is a 256-bit AES key that is stored in Efuse block 2. The bootloader can generate this key itself from the internal hardware random number generator, the user does not need to supply it (it is optionally possible to supply this key, see <a class="reference internal" href="secure-boot.html#secure-boot-reflashable"><span class="std std-ref">Re-Flashable Software Bootloader</span></a>). The Efuse holding this key is read &amp; write protected (preventing software access) before secure boot is enabled.</li>
<li>&#8220;secure boot signing key&#8221; is a standard ECDSA public/private key pair (see <a class="reference internal" href="secure-boot.html#secure-boot-image-signing-algorithm"><span class="std std-ref">Image Signing Algorithm</span></a>) in PEM format.<ul>
<li>The public key from this key pair (for signature verificaton but not signature creation) is compiled into the software bootloader and used to verify the second stage of booting (partition table, app image) before booting continues. The public key can be freely distributed, it does not need to be kept secret.</li>
<li>The private key from this key pair <em>must be securely kept private</em>, as anyone who has this key can authenticate to any bootloader that is configured with secure boot and the matching public key.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="how-to-enable-secure-boot">
<span id="secure-boot-howto"></span><h2>How To Enable Secure Boot<a class="headerlink" href="secure-boot.html#how-to-enable-secure-boot" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Run <code class="docutils literal"><span class="pre">make</span> <span class="pre">menuconfig</span></code>, navigate to &#8220;Secure Boot Configuration&#8221; and select the option &#8220;One-time Flash&#8221;. (To understand the alternative &#8220;Reflashable&#8221; choice, see <a class="reference internal" href="secure-boot.html#secure-boot-reflashable"><span class="std std-ref">Re-Flashable Software Bootloader</span></a>.)</p>
</li>
<li><p class="first">Select a name for the secure boot signing key. This option will appear after secure boot is enabled. The file can be anywhere on your system. A relative path will be evaluated from the project directory. The file does not need to exist yet.</p>
</li>
<li><p class="first">Set other menuconfig options (as desired). Pay particular attention to the &#8220;Bootloader Config&#8221; options, as you can only flash the bootloader once. Then exit menuconfig and save your configuration</p>
</li>
<li><p class="first">The first time you run <code class="docutils literal"><span class="pre">make</span></code>, if the signing key is not found then an error message will be printed with a command to generate a signing key via <code class="docutils literal"><span class="pre">espsecure.py</span> <span class="pre">generate_signing_key</span></code>.</p>
<p><strong>IMPORTANT</strong> A signing key generated this way will use the best random number source available to the OS and its Python installation (<cite>/dev/urandom</cite> on OSX/Linux and <cite>CryptGenRandom()</cite> on Windows). If this random number source is weak, then the private key will be weak.</p>
<p><strong>IMPORTANT</strong> For production environments, we recommend generating the keypair using openssl or another industry standard encryption program. See <a class="reference internal" href="secure-boot.html#secure-boot-generate-key"><span class="std std-ref">Generating Secure Boot Signing Key</span></a> for more details.</p>
</li>
<li><p class="first">Run <code class="docutils literal"><span class="pre">make</span> <span class="pre">bootloader</span></code> to build a secure boot enabled bootloader. The output of <code class="docutils literal"><span class="pre">make</span></code> will include a prompt for a flashing command, using <code class="docutils literal"><span class="pre">esptool.py</span> <span class="pre">write_flash</span></code>.</p>
</li>
</ol>
<ol class="arabic" id="secure-boot-resume-normal-flashing" start="6">
<li><p class="first">When you&#8217;re ready to flash the bootloader, run the specified command (you have to enter it yourself, this step is not performed by make) and then wait for flashing to complete. <strong>Remember this is a one time flash, you can&#8217;t change the bootloader after this!</strong>.</p>
</li>
<li><p class="first">Run <code class="docutils literal"><span class="pre">make</span> <span class="pre">flash</span></code> to build and flash the partition table and the just-built app image. The app image will be signed using the signing key you generated in step 4.</p>
<p><em>NOTE</em>: <code class="docutils literal"><span class="pre">make</span> <span class="pre">flash</span></code> doesn&#8217;t flash the bootloader if secure boot is enabled.</p>
</li>
<li><p class="first">Reset the ESP32 and it will boot the software bootloader you flashed. The software bootloader will enable secure boot on the chip, and then it verifies the app image signature and boots the app. You should watch the serial console output from the ESP32 to verify that secure boot is enabled and no errors have occured due to the build configuration.</p>
</li>
</ol>
<p><strong>NOTE</strong> Secure boot won&#8217;t be enabled until after a valid partition table and app image have been flashed. This is to prevent accidents before the system is fully configured.</p>
<ol class="arabic simple" start="9">
<li>On subsequent boots, the secure boot hardware will verify the software bootloader has not changed (using the secure bootloader key) and then the software bootloader will verify the signed partition table and app image (using the public key portion of the secure boot signing key).</li>
</ol>
</div>
<div class="section" id="re-flashable-software-bootloader">
<span id="secure-boot-reflashable"></span><h2>Re-Flashable Software Bootloader<a class="headerlink" href="secure-boot.html#re-flashable-software-bootloader" title="Permalink to this headline">¶</a></h2>
<p>Configuration &#8220;Secure Boot: One-Time Flash&#8221; is the recommended configuration for production devices. In this mode, each device gets a unique key that is never stored outside the device.</p>
<p>However, an alternative mode &#8220;Secure Boot: Reflashable&#8221; is also available. This mode allows you to supply a 256-bit key file that is used for the secure bootloader key. As you have the key file, you can generate new bootloader images and secure boot digests for them.</p>
<p>In the esp-idf build process, this 256-bit key file is derived from the app signing key generated during the generate_signing_key step above. The private key&#8217;s SHA-256 digest is used as the 256-bit secure bootloader key. This is a convenience so you only need to generate/protect a single private key.</p>
<p><strong>NOTE</strong>: Although it&#8217;s possible, we strongly recommend not generating one secure boot key and flashing it to every device in a production environment. The &#8220;One-Time Flash&#8221; option is recommended for production environments.</p>
<p>To enable a reflashable bootloader:</p>
<ol class="arabic simple">
<li>In the <code class="docutils literal"><span class="pre">make</span> <span class="pre">menuconfig</span></code> step, select &#8220;Bootloader Config&#8221; -&gt; &#8220;Secure Boot&#8221; -&gt; &#8220;Reflashable&#8221;.</li>
<li>Follow the steps shown above to choose a signing key file, and generate the key file.</li>
<li>Run <code class="docutils literal"><span class="pre">make</span> <span class="pre">bootloader</span></code>. A 256-bit key file will be created, derived from the private key that is used for signing. Two sets of flashing steps will be printed - the first set of steps includes an <code class="docutils literal"><span class="pre">espefuse.py</span> <span class="pre">burn_key</span></code> command which is used to write the bootloader key to efuse. (Flashing this key is a one-time-only process.) The second set of steps can be used to reflash the bootloader with a pre-calculated digest (generated during the build process).</li>
<li>Resume from <a class="reference internal" href="secure-boot.html#secure-boot-resume-normal-flashing"><span class="std std-ref">Step 6 of the one-time flashing process</span></a>, to flash the bootloader and enable secure boot. Watch the console log output closely to ensure there were no errors in the secure boot configuration.</li>
</ol>
</div>
<div class="section" id="generating-secure-boot-signing-key">
<span id="secure-boot-generate-key"></span><h2>Generating Secure Boot Signing Key<a class="headerlink" href="secure-boot.html#generating-secure-boot-signing-key" title="Permalink to this headline">¶</a></h2>
<p>The build system will prompt you with a command to generate a new signing key via <code class="docutils literal"><span class="pre">espsecure.py</span> <span class="pre">generate_signing_key</span></code>. This uses the python-ecdsa library, which in turn uses Python&#8217;s os.urandom() as a random number source.</p>
<p>The strength of the signing key is proportional to (a) the random number source of the system, and (b) the correctness of the algorithm used. For production devices, we recommend generating signing keys from a system with a quality entropy source, and using the best available EC key generation utilities.</p>
<p>For example, to generate a signing key using the openssl command line:</p>
<p><code class="docutils literal"><span class="pre">`</span>
<span class="pre">openssl</span> <span class="pre">ecparam</span> <span class="pre">-name</span> <span class="pre">prime256v1</span> <span class="pre">-genkey</span> <span class="pre">-noout</span> <span class="pre">-out</span> <span class="pre">my_secure_boot_signing_key.pem</span>
<span class="pre">`</span></code></p>
<p>Remember that the strength of the secure boot system depends on keeping the signing key private.</p>
</div>
<div class="section" id="remote-signing-of-images">
<h2>Remote Signing of Images<a class="headerlink" href="secure-boot.html#remote-signing-of-images" title="Permalink to this headline">¶</a></h2>
<p>For production builds, it can be good practice to use a remote signing server rather than have the signing key on the build machine (which is the default esp-idf secure boot configuration). The espsecure.py command line program can be used to sign app images &amp; partition table data for secure boot, on a remote system.</p>
<p>To use remote signing, disable the option &#8220;Sign binaries during build&#8221;. The private signing key does not need to be present on the build system. However, the public (signature verification) key is required because it is compiled into the bootloader (and can be used to verify image signatures during OTA updates.</p>
<p>To extract the public key from the private key:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">espsecure</span><span class="o">.</span><span class="n">py</span> <span class="n">extract_public_key</span> <span class="o">--</span><span class="n">keyfile</span> <span class="n">PRIVATE_SIGNING_KEY</span> <span class="n">PUBLIC_VERIFICATION_KEY</span>
</pre></div>
</div>
<p>The path to the public signature verification key needs to be specified in the menuconfig under &#8220;Secure boot public signature verification key&#8221; in order to build the secure bootloader.</p>
<p>After the app image and partition table are built, the build system will print signing steps using espsecure.py:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">espsecure</span><span class="o">.</span><span class="n">py</span> <span class="n">sign_data</span> <span class="o">--</span><span class="n">keyfile</span> <span class="n">PRIVATE_SIGNING_KEY</span> <span class="n">BINARY_FILE</span>
</pre></div>
</div>
<p>The above command appends the image signature to the existing binary. You can use the <cite>&#8211;output</cite> argument to write the signed binary to a separate file:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">espsecure</span><span class="o">.</span><span class="n">py</span> <span class="n">sign_data</span> <span class="o">--</span><span class="n">keyfile</span> <span class="n">PRIVATE_SIGNING_KEY</span> <span class="o">--</span><span class="n">output</span> <span class="n">SIGNED_BINARY_FILE</span> <span class="n">BINARY_FILE</span>
</pre></div>
</div>
</div>
<div class="section" id="secure-boot-best-practices">
<h2>Secure Boot Best Practices<a class="headerlink" href="secure-boot.html#secure-boot-best-practices" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Generate the signing key on a system with a quality source of entropy.</li>
<li>Keep the signing key private at all times. A leak of this key will compromise the secure boot system.</li>
<li>Do not allow any third party to observe any aspects of the key generation or signing process using espsecure.py. Both processes are vulnerable to timing or other side-channel attacks.</li>
<li>Enable all secure boot options in the Secure Boot Configuration. These include flash encryption, disabling of JTAG, disabling BASIC ROM interpeter, and disabling the UART bootloader encrypted flash access.</li>
<li>Use secure boot in combination with <a class="reference internal" href="flash-encryption.html"><span class="doc">flash encryption</span></a> to prevent local readout of the flash contents.</li>
</ul>
</div>
<div class="section" id="technical-details">
<span id="secure-boot-technical-details"></span><h2>Technical Details<a class="headerlink" href="secure-boot.html#technical-details" title="Permalink to this headline">¶</a></h2>
<p>The following sections contain low-level reference descriptions of various secure boot elements:</p>
<div class="section" id="secure-boot-hardware-support">
<span id="id1"></span><h3>Secure Boot Hardware Support<a class="headerlink" href="secure-boot.html#secure-boot-hardware-support" title="Permalink to this headline">¶</a></h3>
<p>The first stage of secure boot verification (checking the software bootloader) is done via hardware. The ESP32&#8217;s Secure Boot support hardware can perform three basic operations:</p>
<ol class="arabic simple">
<li>Generate a random sequence of bytes from a hardware random number generator.</li>
<li>Generate a digest from data (usually the bootloader image from flash) using a key stored in Efuse block 2. The key in Efuse can (&amp; should) be read/write protected, which prevents software access. For full details of this algorithm see <cite>Secure Bootloader Digest Algorithm</cite>. The digest can only be read back by software if Efuse ABS_DONE_0 is <em>not</em> burned (ie still 0).</li>
<li>Generate a digest from data (usually the bootloader image from flash) using the same algorithm as step 2 and compare it to a pre-calculated digest supplied in a buffer (usually read from flash offset 0x0). The hardware returns a true/false comparison without making the digest available to software. This function is available even when Efuse ABS_DONE_0 is burned.</li>
</ol>
</div>
<div class="section" id="secure-bootloader-digest-algorithm">
<h3>Secure Bootloader Digest Algorithm<a class="headerlink" href="secure-boot.html#secure-bootloader-digest-algorithm" title="Permalink to this headline">¶</a></h3>
<p>Starting with an &#8220;image&#8221; of binary data as input, this algorithm generates a digest as output. The digest is sometimes referred to as an &#8220;abstract&#8221; in hardware documentation.</p>
<p>For a Python version of this algorithm, see the <code class="docutils literal"><span class="pre">espsecure.py</span></code> tool in the components/esptool_py directory (specifically, the <code class="docutils literal"><span class="pre">digest_secure_bootloader</span></code> command).</p>
<p>Items marked with (^) are to fulfill hardware restrictions, as opposed to cryptographic restrictions.</p>
<ol class="arabic simple">
<li>Prefix the image with a 128 byte randomly generated IV.</li>
<li>If the image length is not modulo 128, pad the image to a 128 byte boundary with 0xFF. (^)</li>
<li>For each 16 byte plaintext block of the input image:
- Reverse the byte order of the plaintext input block (^)
- Apply AES256 in ECB mode to the plaintext block.
- Reverse the byte order of the ciphertext output block. (^)
- Append to the overall ciphertext output.</li>
<li>Byte-swap each 4 byte word of the ciphertext (^)</li>
<li>Calculate SHA-512 of the ciphertext.</li>
</ol>
<p>Output digest is 192 bytes of data: The 128 byte IV, followed by the 64 byte SHA-512 digest.</p>
</div>
<div class="section" id="image-signing-algorithm">
<span id="secure-boot-image-signing-algorithm"></span><h3>Image Signing Algorithm<a class="headerlink" href="secure-boot.html#image-signing-algorithm" title="Permalink to this headline">¶</a></h3>
<p>Deterministic ECDSA as specified by <a class="reference external" href="https://tools.ietf.org/html/rfc6979">RFC 6979</a>.</p>
<ul class="simple">
<li>Curve is NIST256p (openssl calls this curve &#8220;prime256v1&#8221;, it is also sometimes called secp256r1).</li>
<li>Hash function is SHA256.</li>
<li>Key format used for storage is PEM.<ul>
<li>In the bootloader, the public key (for signature verification) is flashed as 64 raw bytes.</li>
</ul>
</li>
<li>Image signature is 68 bytes - a 4 byte version word (currently zero), followed by a 64 bytes of signature data. These 68 bytes are appended to an app image or partition table data.</li>
</ul>
</div>
<div class="section" id="manual-commands">
<h3>Manual Commands<a class="headerlink" href="secure-boot.html#manual-commands" title="Permalink to this headline">¶</a></h3>
<p>Secure boot is integrated into the esp-idf build system, so <code class="docutils literal"><span class="pre">make</span></code> will automatically sign an app image if secure boot is enabled. <code class="docutils literal"><span class="pre">make</span> <span class="pre">bootloader</span></code> will produce a bootloader digest if menuconfig is configured for it.</p>
<p>However, it is possible to use the <code class="docutils literal"><span class="pre">espsecure.py</span></code> tool to make standalone signatures and digests.</p>
<p>To sign a binary image:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">espsecure</span><span class="o">.</span><span class="n">py</span> <span class="n">sign_data</span> <span class="o">--</span><span class="n">keyfile</span> <span class="o">./</span><span class="n">my_signing_key</span><span class="o">.</span><span class="n">pem</span> <span class="o">--</span><span class="n">output</span> <span class="o">./</span><span class="n">image_signed</span><span class="o">.</span><span class="n">bin</span> <span class="n">image</span><span class="o">-</span><span class="n">unsigned</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<p>Keyfile is the PEM file containing an ECDSA private signing key.</p>
<p>To generate a bootloader digest:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">espsecure</span><span class="o">.</span><span class="n">py</span> <span class="n">digest_secure_bootloader</span> <span class="o">--</span><span class="n">keyfile</span> <span class="o">./</span><span class="n">securebootkey</span><span class="o">.</span><span class="n">bin</span> <span class="o">--</span><span class="n">output</span> <span class="o">./</span><span class="n">bootloader</span><span class="o">-</span><span class="n">digest</span><span class="o">.</span><span class="n">bin</span> <span class="n">build</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">bootloader</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<p>Keyfile is the 32 byte raw secure boot key for the device. To flash this digest onto the device:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">esptool</span><span class="o">.</span><span class="n">py</span> <span class="n">write_flash</span> <span class="mh">0x0</span> <span class="n">bootloader</span><span class="o">-</span><span class="n">digest</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../api-guides/ulp.html" class="btn btn-neutral float-right" title="ULP coprocessor programming" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../api-guides/partition-tables.html" class="btn btn-neutral" title="Partition Tables" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 - 2017, Espressif.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v3.0-dev-806-gde750e9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>