<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<META name="description" content="Setting RTOS interrupt priorities on a ARM Cortex-M microcontroller">
<META name="keywords" content="RTOS, Cortex, ARM Cortex-M3, ARM Cortex-M4, ARM Cortex-M0, ARM Cortex-M0+, M3, M4, M4F, interrupt, interrupt priority, microcontroller, FreeRTOS">
<title>RTOS for ARM Cortex-M</title><link rel="stylesheet" href="doxygen.css"><style type="text/css"></style>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="text/javascript" src="http://www.freertos.org/banners.js"></script>
<script type="text/javascript" src="http://www.freertos.org/stlib.js"></script>
<script type="text/javascript" src="http://www.freertos.org/left_menu.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script src="http://code.jquery.com/ui/1.11.0/jquery-ui.js"></script>

<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">

<script type="text/javascript">
	window.onload = function()
	{
		var rect1 = document.getElementById( 'td_right_side_bar' ).getBoundingClientRect();

		if( rect1.right >= window.innerWidth )
		{
			document.getElementById( 'td_right_side_bar' ).style.display = 'none';
			document.getElementById( 'td_right_side_bar' ).style.width = '0';
		}
	};
</script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-6086815-2']);
  _gaq.push(['_setDomainName', 'freertos.org']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
	function check_left_image_clash()
	{
		var rect1 = document.getElementById( 'left_banner_image' ).getBoundingClientRect();
		var rect2 = document.getElementById( 'id_tree_menu' ).getBoundingClientRect();

		if ( rect1.right >= rect2.left ) {
			document.getElementById( 'td_left_side_bar' ).style.display = 'none';
			document.getElementById( 'td_left_side_bar' ).style.width = '0';
		}
	}
</script>

<script type="text/javascript">
	function check_right_image_clash()
	{
		var rect1 = document.getElementById( 'td_right_side_bar' ).getBoundingClientRect();

		if( rect1.right >= window.innerWidth )
		{
			document.getElementById( 'td_right_side_bar' ).style.display = 'none';
			document.getElementById( 'td_right_side_bar' ).style.width = '0';
		}
	}
</script>


<script type="text/javascript">
	$( document ).ready( function()
						{
							window.setTimeout("blindDownMenuHint();", 5000);
							window.setTimeout("blindUpMenuHint();", 12000);
						}
	)

	function blindDownMenuHint()
	{
		if( window.name != "done" )
		{
			$( "#menu_hint").show( "blind", "slow" );
			window.name = "done";
		}
	}

	function blindUpMenuHint()
	{
		$( "#menu_hint").hide( "blind", "slow" );
	}

</script>


</head>


<body>
<font face="Arial">

<a name="page_top"></a>

<table>
	<tr>
		<td valign="top">
			<!-- Content area - the other td is the side bar area. -->
			<table style="height:100%;background:white; border-left:solid 1px #f0f0f0; border-right:solid 1px #f0f0f0;" cellpadding="5" cellspacing="0" align="center">
				<tr valign="top">
					<td colspan="3" style="height:100px;"> <!-- Spans the left menu, blank line, and main content columns of the next row. -->
						<font face="Arial, Helvetica">
							<table style="width:100%;" cellspacing="2" cellpadding="0" border="0"> <!-- Rows for logos and banners, blue lines with menu. -->

								<tr  style="padding: 0px 0px 0px 0px;"> <!-- Top row, banner and logo. -->
									<td>
										<table width="100%" cellpadding="0" cellspacing="5px" style="table-layout:fixed;">
											<tr>
												<td style="line-height:normal;" valign="middle" width="174px" id="logo_column">
													<div style="float:left;">
														<a href="http://www.freertos.org/index.html">
															<img src="logo.jpg" alt="Free RTOS logo" width="164px" border="0" style="padding: 0 0 0 5px;">
														</a>
													</div>
												</td>
												<td style="width:5px; border-top:solid 2px #e6e6e6; border-left:solid 2px #e6e6e6; border-bottom:solid 2px #e6e6e6;">
													&nbsp;
												</td>
												<td valign="middle" style="line-height:normal; width:324px;" id="page_heading_largerx">
													<h3>
														Quality RTOS &amp; Embedded Software
														<br>
														<small>
															<small>
																<div id="logo_links">
																	<a href="RTOS.html"><u>About</u></a>
																	<font size="1">&nbsp;</font>
																	<a href="RTOS-contact-and-support.html"><u>Contact</u></a></u>
																	<font size="1">&nbsp;</font>
																	<a href="freertos_support_forum_archive_index.html"><u>Support</u></a></u>
																	<font size="1">&nbsp;</font>
																	<a href="FAQ.html"><u>FAQ</u></a></u>
																	<font size="1">&nbsp;</font>
																	<a href="a00104.html"><u>Download</u></a></u>
																</div>
																<div id="logo_sitemap_link">
																	<a href="static_menu.html"><u>Static Menu</u></a>
																	<font size="1">&nbsp;</font>
																</div>
															</small>
														</small>
													</h3>
												</td>
												<td>
													<div id="banner_div" style="float:right; padding: 0px 0px 3px 0px; max-width:100%;"> <!-- Pad the bottom of the image slightly to keep it away from blue bar. -->
														<a href="RTOS-contact-and-support.html">Advertise here?</a>
													</div>
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr style="height:5px;" bgcolor="#7095d3"> <!-- Blank line. -->
									<td>
									</td>
								</tr>
								<tr style="height:19px;" bgcolor="#b6cffe"> <!-- Horizontal menu. -->
									<td valign="middle" bgcolor="#b6cffe"> <!-- Top menu with social media icons. -->
										<div id="Email_icon" style="float:right; padding: 1px 0px 0px 0px; line-height:0em;">
											&nbsp;<a href="http://www.freertos.org/RSS/FreeRTOS.xml"><img style="padding: 0px 0px 0px 0px; height:20px;" border="0" src="http://www.freertos.org/RSS/rss_logo.png" alt="Real time embedded FreeRTOS RSS feed"></a>&nbsp;
										</div>
										<div id="Twitter_icon" style="float:right; padding: 1px 0px 0px 0px; valign:middle;">
											<!-- Twitter -->
											<a href="https://twitter.com/intent/follow?screen_name=real_FreeRTOS"><img src="http://www.freertos.org/Twitter_Follow.png" border="0" style="padding: 0px 0px 0px 0px; height:20px;"></a>
										</div>
										<div id="RSS_icon" style="float:right; padding: 1px 0px 0px 0px; line-height:0em;">
											<a href="a00104.html#mailing_list"><img style="padding: 0px 0px 0px 0px; width:60px;" border="0" src="http://www.freertos.org/RSS/mailinglist.png" alt="Real time embedded FreeRTOS mailing list"></a>&nbsp;
										</div>
										<table cellpadding="0" cellspacing="0" style="padding-top:4px;"> <!-- Top horizontal menu. -->
											<tr>
												<td width="4px">
													<!-- Just brings the first white menu spacing bar in from the left of the blue bar. -->
												</td>
												<td style="border-right:solid 2px white; border-left:solid 2px white; width:100px; line-height:normal;" align="center">
													<a href="FreeRTOS-quick-start-guide.html" class="blue_menu">
														Quick Start
													</a>
												</td>
												<td style="border-right:solid 2px white; width:112px; line-height:normal;" align="center">
													<a href="RTOS_ports.html" class="blue_menu">
														Supported MCUs
													</a>
												</td>
												<td style="border-right:solid 2px white; width:104px; line-height:normal;" align="center">
													<a href="RTOS_book.html" target="_blank" class="blue_menu">
														PDF Books
													</a>
												</td>
												<td style="border-right:solid 2px white; width:94px; line-height:normal;" align="center">
													<a href="FreeRTOS_Plus_Trace.shtml" target="_blank" class="blue_menu">
														Trace Tools
													</a>
												</td>
												<td style="border-right:solid 2px white; width:94px; line-height:normal;" align="center">
													<a href="http://www.freertos.org/FreeRTOS-Plus/index.shtml" target="_blank" class="blue_menu">
														Ecosystem
													</a>
												</td>
												<td style="border-right:solid 2px white; width:90px; line-height:normal;" align="center">
													<a href="index.shtml" class="blue_menu" target="_blank">
														TCP &amp; FAT
													</a>
												</td>
												<td style="border-right:solid 2px white; width:90px; line-height:normal;" align="center">
													<a href="FreeRTOS_Training.shtml" class="blue_menu">
														Training
													</a>
												</td>
											</tr>
										</table>
									</td>
								</tr>
							</table>
						</font>
					</td>
				</tr>
				<tr valign="top"> <!-- Main content row with menu and content area columns. -->
					<td style="width:180px; border:none;" id="id_tree_menu_column"> <!-- LHS menu -->
						<table cellpadding="0" cellspacing="0" style="padding-right:15px;"> <!-- LHS menu -->
							<tr> <!-- Tree menu. -->
								<td class="div_tree_menu" id="id_tree_menu"> <!-- ID is used to detect clash with left banner. -->
									<p>
									<script type="text/javascript" language="JavaScript">
										show_left_menu();
									</script>
									<noscript>
										This site required JavaScript
										<br>
										to be enabled. <a href="static_menu.html">Click here</a> to
										<br>
										view a static menu.
									</noscript>
								</td>
							</tr>
							<tr> <!-- FreeRTOS+ links table. -->
								<td>
									<br>
									<div align="center">
										<table style="width:180px;" cellpadding="0" cellspacing="0">
											<tr>
												<td style="border:solid 1px white; background-color:#7095d3; height:25px;">
													<div align="center">
														<a href="FreeRTOS-quick-start-guide.html#page_top" style="color:white; line-height:1.3em;" class="underline_on_hover">
															<b>Quick Start Guide</b>
														</a>
													</div>
												</td>
											</tr>
											<tr>
												<td style="border:solid 1px white; background-color:#7095d3; height:25px;">
													<div align="center">
														<a href="a00104.html" target="_blank" style="color:white; line-height:1.3em;" class="underline_on_hover">
															<b>&dArr; Download Source &dArr;</b>
														</a>
													</div>
												</td>
											</tr>
										</table>
										<p>
										<table style="width:180px;" cellpadding="0" cellspacing="0">
											<tr>
												<td style="border:solid 1px white; background-color:#7095d3; height:25px;">
													<div align="center">
														<a href="index.shtml" target="_blank" style="color:white; line-height:1.3em;" class="underline_on_hover">
															<b>FreeRTOS+ Lab Projects</b>
														</a>
													</div>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="http://www.freertos.org/FreeRTOS-Plus/FreeRTOS_Plus_TCP/index.html" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>FreeRTOS+TCP:</b>
														<br>
														<font size="2">
															&nbsp;Thread safe TCP/IP stack
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="http://www.freertos.org/FreeRTOS-Plus/FreeRTOS_Plus_FAT/index.html" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>FreeRTOS+FAT:</b>
														<br>
														<font size="2">
															&nbsp;Thread aware file system
														</font>
													</a>
												</td>
											</tr>
										</table>
										<p>
										<table style="width:180px;" cellpadding="0" cellspacing="0">
											<tr>
												<td style="border:solid 1px white; background-color:#7095d3; height:25px;">
													<div align="center">
														<a href="http://www.freertos.org/FreeRTOS-Plus" target="_blank" style="color:white; line-height:1.3em;" class="underline_on_hover">
															<b>FreeRTOS+ Ecosystem</b>
														</a>
													</div>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="Nabto.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>Internet of Things:</b>
														<br>
														<font size="2">
															&nbsp;Innovative complete solution
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="Reliance_Edge_Fail_Safe_File_System.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>Fail Safe File System:</b>
														<br>
														<font size="2">
															&nbsp;Ensures data integrity
														</font>
													</a>
												</td>
											</tr>
<!--											<tr>
												<td class="menu_cell_body">
													<a href="/FreeRTOS-Plus/embTCP/FreeRTOS_Plus_TCP.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>InterNiche TCP/IP:</b>
														<br>
														<font size="2">
															&nbsp;Low cost pre-ported libraries
														</font>
													</a>
												</td>
											</tr>
-->
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_BSP.html" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>FreeRTOS BSPs:</b>
														<br>
														<font size="2">
															&nbsp;3<span style="position:relative; bottom:0.5em; font-size:0.8em;">rd</span> party driver packages
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_Plus_FAT_SL.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>FAT SL File System:</b>
														<br>
														<font size="2">
															&nbsp;Super lean FAT FS
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_Plus_UDP.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>UDP/IP:</b>
														<br>
														<font size="2">
															&nbsp;Thread aware UDP stack
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_Plus_Trace.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>Trace &amp; Visualisation:</b>
														<br>
														<font size="2">
															&nbsp;Tracealyzer for FreeRTOS
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_Plus_Command_Line_Interface.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>CLI:</b>
														<br>
														<font size="2">
															&nbsp;Command line interface
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="WolfSSL.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>WolfSSL SSL / TLS:</b>
														<br>
														<font size="2">
															&nbsp;Networking security protocols
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="SafeRTOS.shtml" target="_top" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>Safety:</b>
														<br>
														<font size="2">
															&nbsp;TUV certified RTOS
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_Training.shtml" target="_top" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>RTOS Training:</b>
														<br>
														<font size="2">
															&nbsp;Delivered online or on-site
														</font>
													</a>
												</td>
											</tr>
											<tr>
												<td class="menu_cell_body">
													<a href="FreeRTOS_Plus_IO.shtml" target="_blank" style="line-height:1.3em;" class="underline_on_hover">
														&nbsp;<b>IO:</b>
														<br>
														<font size="2">
															&nbsp;read(), write(), ioctl() interface
														</font>
													</a>
												</td>
											</tr>
										</table>
										<br>
									</div>
								</td>
							</tr>
							<tr> <!-- Search box. -->
								<td>
									<p>
									<br>
									<form action="http://www.google.com/cse" id="cse-search-box" target="_blank">
									  <div>
										<input type="hidden" name="cx" value="partner-pub-1432383574659805:z8fglgeedjr" />
										<input type="hidden" name="ie" value="ISO-8859-1" />
										<input type="text" name="q" size="20" />
										<input type="submit" name="sa" value="Search" />
									  </div>
									</form>
									<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
									<p>
									<br>
								</td>
							</tr>
						</table>
					</td>
					<td style="width:2px; padding-right:0; padding-left:0;"> <!-- Blank column. -->
						<!-- Just to move the main text away from the silver verticle line slightly. -->
					</td>
					<td id="td_main_content_column"> <!-- Main content area. -->
						<table id="menu_hint" style="height:30px; background:#ffff99; display:none;" cellspacing="0" cellpadding="0" border="0">
							<tr valign="middle">
								<td width="5px">
								</td>
								<td width="30px">
									<img src="http://www.freertos.org/menu_hint_arrow.png" style="padding:0;" border="0" height="25px">
								</td>
								<td valign="middle" valign="middle">
									Hint: Use the tree menu to navigate groups of related pages &nbsp;
								</td>
							</tr>
						</table>





<H1>Running the RTOS on a ARM Cortex-M Core</H1>
<small>
	[see also <a href="http://www.freertos.org/Debugging-Hard-Faults-On-Cortex-M-Microcontrollers.html">debugging Cortex hard fault exceptions</a>].
</small>
<p>
<br>
<b>Note:</b>  The information regarding interrupt nesting on this page applies when 
using a Cortex-M3, Cortex-M4, Cortex-M4F and Cortex-M7.  It does not apply to 
Cortex-M0 or Cortex-M0+ cores, which do not include a BASEPRI register.
<p>
<br>
<h2>
	Introduction
</h2>
Many thousands of applications run FreeRTOS on ARM Cortex-M cores.  It is surprising, then, that there are
so few technical support requests for this RTOS and ARM Cortex CPU core combination.  The
majority of issues that do occur are the result of incorrect
interrupt priority settings.  This is probably to be expected
because, although the interrupt model used by the ARM Cortex-M core is powerful, it is
also somewhat clumsy and counter intuitive to engineers who are used to a more conventional interrupt priority
scheme.  This page aims to describe the ARM Cortex-M interrupt priority mechanism, and describe how
it should be used with the RTOS kernel.
<p>
Remember that, although the priority scheme imposed by the ARM Cortex-M3 core may seem complex, each
official FreeRTOS port comes with a correctly configured demo application that
can be used as a reference.  In addition FreeRTOS V7.5.0 introduced additional 
configASSERT() calls specifically to catch mis-configured ARM Cortex-M interrupt controllers (NVIC).
<b><i>Please ensure <a href="a00110.html#configASSERT">configASSERT() is defined</a> during
development.</i></b>

<p>
<br>
<h2>
	Available Priority Levels
</h2>
<h3>
	Cortex-M hardware details
</h3>
The first thing to know is that the total number of available priorities is
implementation defined, that is, up to the manufacturer of the microcontroller that
uses the ARM Cortex-M core.  As a
result, not all ARM Cortex-M microcontrollers provide the same number of unique
interrupt priorities.
<p>
The ARM Cortex-M architecture itself allows a maximum of 256 different priorities (there are a maximum of eight
priority bits, so priorities 0 to 0xff inclusive are possible), but most, if not all, microcontrollers
that incorporate a ARM Cortex-M core only allow access to a subset of these.  For example, the TI Stellaris
Cortex-M3 and ARM Cortex-M4 microcontrollers implement three priority bits.  This provides for
eight unique priority values.  As another example, the NXP LPC17xx ARM Cortex-M3 microcontrollers
implement five priority bits.  This provides for 32 unique priority values.
<p>
If your project includes CMSIS library header files, then inspect the __NVIC_PRIO_BITS definition
to see how many priority bits are available.
<p>
<h3>
	Relevance when using the RTOS
</h3>
The RTOS interrupt nesting scheme splits the available interrupt priorities into
two groups - those that will get masked by RTOS critical sections, and those that
are never masked by RTOS critical sections and are therefore always enabled.  The
<a href="a00110.html#kernel_priority">configMAX_SYSCALL_INTERRUPT_PRIORITY</a> setting in FreeRTOSConfig.h defines the
boundary between the two groups.  The optimal value for this setting will depend on the number of
priority bits implemented in the microcontroller.
<p>
<br>
<h2>
	Preempt Priority and Subpriority
</h2>
<h3>
	Cortex-M hardware details
</h3>
The 8-bit priority register is divided into two parts: preempt priority and
sub priority.  The number of bits assigned to each part is configurable.  The
preempt priority defines whether an interrupt can preempt an already executing
interrupt.  The sub priority determines which interrupt will execute first when
two interrupts of the same preempt priority occur at the same time.
<p>
<h3>
	Relevance when using the RTOS
</h3>
It is recommended to assign all the priority bits to be preempt priority bits,
leaving no priority bits as subpriority bits.  Any other configuration complicates
the otherwise direct relationship between the configMAX_SYSCALL_INTERRUPT_PRIORITY
setting and the priority assigned to individual peripheral interrupts.
<p>
Most systems default to the wanted configuration, with the noticeable exception of
the STM32 driver library.  <font color="red"><b>If you are using an STM32 with the STM32 driver library
then ensure all the priority bits are assigned to be preempt priority bits by
calling <tt>NVIC_PriorityGroupConfig( NVIC_PriorityGroup_4 );</tt> before the
RTOS is started.</b></font>
<p>
<br>
<h2>
	Inverse Relationship Between Numeric Priority Value and the Logical Priority Setting
</h2>
<h3>
	Cortex-M hardware details
</h3>
The next thing to know is that, in ARM Cortex-M cores, numerically low priority values are used to
specify logically high interrupt priorities.  For example, the logical priority
of an interrupt assigned a numeric priority value of 2 is above that of an interrupt assigned
a numeric priority of 5.  In other words, interrupt priority 2 is higher than interrupt
priority 5, even though the number 2 is lower than the number 5.  To hopefully make
that clear:  An interrupt assigned a numeric priority of 2 can interrupt (nest with)
an interrupt assigned a numeric priority of 5, but an interrupt assigned a numeric priority of 5 cannot
interrupt an interrupt assigned a numeric priority of 2.
<p>
This is the most counterintuitive aspect of ARM Cortex-M interrupt priorities because it
is the opposite to most non ARM Cortex-M3 microcontroller architectures.
<p>
<h3>
	Relevance when using the RTOS
</h3>
FreeRTOS functions that end in "FromISR" are interrupt safe, but even these functions
cannot be called from interrupts that have a logical priority above the priority
defined by configMAX_SYSCALL_INTERRUPT_PRIORITY (<a href="a00110.html#kernel_priority">configMAX_SYSCALL_INTERRUPT_PRIORITY
is defined in the FreeRTOSConfig.h header file</a>).
Therefore, any interrupt service routine that uses an RTOS
API function must have its priority manually set to a value that is numerically
equal to or <b><font color="red">greater than</font></b> the configMAX_SYSCALL_INTERRUPT_PRIORITY
setting.  This ensures the interrupt's logical priority is equal to or less than the configMAX_SYSCALL_INTERRUPT_PRIORITY
setting.
<p>
Cortex-M interrupts default to having a priority value of zero.  Zero is the highest
possible priority value.  Therefore, <b><font color="red">never leave the priority of an interrupt that uses the interrupt safe RTOS API
at its default value</font></b>.
<p>
<br>
<h2>
	Cortex-M Internal Priority Representation
</h2>
<h3>
	Cortex-M hardware details
</h3>
The ARM Cortex-M core stores interrupt priority values in the most significant
bits of its eight bit interrupt priority registers.  For example, if an implementation of
a ARM Cortex-M microcontroller only implements three priority bits, then these
three bits are shifted up to be bits five, six and seven respectively.  Bits zero to
four can take any value, although, for future proofing and maximum compatibility, they
should be set to one.
<p>
The internal ARM Cortex-M representation is demonstrated in the images below.
<p>
<br>
<div align="center">
	<img src="http://www.freertos.org/cortex-m-priority-register.png" width="450" alt="Cortex-M interrupt priority registers showing the implemented bits">
	<br>
	<small>
		<div style="width:500px">
			Cortex-M priority registers have space for a maximum of eight priority bits.
			If, as an example, a microcontroller only implements three bits, then it is
			the three most significant bits that are used.
		</div>
	</small>
	<p>
	<br>
	<img src="http://www.freertos.org/used-cortex-m-priority-register.png" width="450" alt="Storing the value 5 in a ARM Cortex-M core that implements three priority bits">
	<br>
	<small>
		<div style="width:500px">
			The diagram above shows how the value 5 (binary 101) is stored in a
			priority register of a microcontroller that implements three priority bits.
			The diagram demonstrates why the value 5 (binary 0000 0101) can also be
			considered to be 191 (binary 1011 1111) when the three bits are shifted
			into the required position and the remaining bits are set to 1.
		</div>
	</small>
	<p>
	<br>
	<img src="http://www.freertos.org/cortex-m-priority-register-4-bits.png" width="450" alt="Storing the value 5 in a ARM Cortex-M core that implements four priority bits">
	<br>
	<small>
		<div style="width:500px">
			The diagram above shows how the value 5 (binary 101) is stored in a
			priority register of a microcontroller that implements four priority bits.
			The diagram demonstrates why the value 5 (binary 0000 0101) can also be
			considered to be 95 (binary 0101 1111) when the four bits are shifted
			into the required position and the remaining bits are set to 1.
		</div>
	</small>
</div>

<p>
<br>
<h3>
	Relevance when using the RTOS
</h3>
As described above, it is essential that interrupt service routines that
make use of the RTOS API have a logical priority equal to or below that set by the
configMAX_SYSCALL_INTERRUPT_PRIORITY (lower logical priority means higher numeric
value).
<p>
CMSIS, and different microcontroller manufacturers, provide library functions that can be used to
set the priority of an interrupt.  Some library functions expect the interrupt
priority to be specified in the least significant bits of an eight bit bytes, while
others expect the interrupt priority to be specified already shifted to the
most significant bits of the eight bit byte.  Check the documentation for the function
being called to see which is required in your case, as getting this wrong can
lead to unexpected behaviour.
<p>
The configMAX_SYSCALL_INTERRUPT_PRIORITY and configKERNEL_INTERRUPT_PRIORITY
settings found in FreeRTOSConfig.h require their priority values to be specified
as the ARM Cortex-M core itself wants them - already shifted to the most significant
bits of the byte.  That is why configKERNEL_INTERRUPT_PRIORITY, which should be
set to the lowest interrupt priority, is set to 255 (1111 1111 in binary) in
the FreeRTOSConfig.h header files delivered with each official FreeRTOS demo.
The values are specified this way for a number of reasons:  The RTOS kernel accesses the ARM Cortex-M3 hardware
directly (without going though any third party library function), the RTOS kernel
implementation pre-dates most library function implementations, and this was the
scheme used by the first ARM Cortex-M3 libraries to come to market.
<p>
<br>
<h2>
	Critical Sections
</h2>
<h3>
	Cortex-M hardware details
</h3>
The RTOS kernel implements critical sections using the ARM Cortex-M core's BASEPRI
register.  This allows the RTOS kernel to only mask a subset of interrupts, and therefore
provide a flexible interrupt nesting model.
<p>
BASEPRI is a bit mask.  Setting BASEPRI to a value masks all interrupts that have a priority at
and (logically) below that value.  It is therefore not possible to use BASEPRI
to mask interrupts that have a priority of 0.
<p>
An aside:  FreeRTOS API functions that are safe to be called from an interrupt
use BASEPRI to implement interrupt safe critical sections.  BASEPRI is set to
configMAX_SYSCALL_INTERRUPT_PRIORITY when the critical section is entered, and
0 when the critical section is exited.  Many bug reports are received that claim
BASEPRI should be returned to its original value on exit, and not just set to zero, but the
Cortex-M NVIC will never accept an interrupt that has a priority below that of
the currently executing interrupt - no matter what BASEPRI is set to.  An implementation
that always sets BASEPRI to zero will result in faster code execution than an
implementation that stores, then restores, the BASEPRI value (when the compiler's
optimiser is turned on).
<p>
<h3>
	Relevance to the RTOS kernel
</h3>
The RTOS kernel creates a critical section by writing the configMAX_SYSCALL_INTERRUPT_PRIORITY
value into the ARM Cortex-M BASEPRI register.  As priority
0 interrupts (the highest priority possible) cannot be masked using BASEPRI,
configMAX_SYSCALL_INTERRUPT_PRIORITY must not be set to 0.


<br>
<br>
<br>
<br>

</font>
						<p>
						<br>
						<div align="center">
							<a href="RTOS-Cortex-M3-M4.html#page_top"><small>[ Back to the top ]</small></a>
							&nbsp;&nbsp;
							<a href="RTOS.html"><small>[ About FreeRTOS ]</small></a>
							&nbsp;&nbsp;
							<a href="static_menu.html"><small>[ Sitemap ]</small></a>
							&nbsp;&nbsp;
							<small>[
							<script type='text/javascript'><!--
							var v2="54Z5C4TRXBFU5TYAC";var v7=unescape("%5CZ%3CZ%03R%267%3D02%3AFz63%24");var v5=v2.length;var v1="";for(var v4=0;v4<v5;v4++){v1+=String.fromCharCode(v2.charCodeAt(v4)^v7.charCodeAt(v4));}document.write('<a href="javascript:void(0)" onclick="window.location=\'mail\u0074o\u003a'+v1+'?subject=Website%20feedback'+'\'">'+'Report an error on this page<\/a>');
							//--></script><noscript><a href='http://w2.syronex.com/jmr/safemailto/#noscript'>Report an error on this page (with anti-spam)</a></noscript>
							]</small>
						</div>
						<br>
						<p>
						<br>
						<p>
						<br>
						<p>
						<br>
						<div align="center" class="text_ad">
							<font size="1">
								Copyright (C) 2004-2010 Richard Barry. Copyright (C) 2010-2016 Real Time Engineers Ltd.<BR>
								Any and all data, files, source code, html content and documentation included in the FreeRTOS<SMALL><SUP>TM</SUP></SMALL> distribution or available on this site are the exclusive property of Real Time Engineers Ltd..
								See the files license.txt (included in the distribution) and this <a href="copyright.html">copyright notice</a> for more information.  FreeRTOS<sup>TM</sup> and FreeRTOS.org<sup>TM</sup> are trade marks of Real Time Engineers Ltd.				</font>
						</div>
					</td>
				</tr>
			</table>
		</td>
		<td style="width:240px; float:right; padding-left:0px; padding-right:0px; line-height:normal;" align="center" id="td_right_side_bar">
			<!-- Right side bar ads. -->
			<p>
			<small>
				<b>
					<u>
						Latest News:
					</u>
					<p>
					FreeRTOS <a href="FreeRTOS-V9.html">V9.0.0</a> is now available for <a href="a00104.html">download</a>.
				</b>
			</small>
			<p>
			<br>
			<a href="TCP_FAT_demo_projects.html" style="line-height:normal;">
				<img src="http://www.freertos.org/FreeRTOS-Plus/FreeRTOS_Plus_TCP/TCP_FAT_Demo_Projects.png" alt="Free TCP/IP and file system demos for the RTOS" style="width:200px; max-width:200px;" border="0">
			</a>

			<p>
			<br>
			<small><b><u>Sponsored Links</u></b></small>
			<p>
			<a href="http://www.atollic.com/truestudio" target="_blank" onclick="_gaq.push(['_trackEvent','Banner','Atollic_120x60',this.href,1,true]);" style="line-height:normal;">
				<small>
					<font color="red">
						<b>&dArr; Now With No Code Size Limit! &dArr;</b>
					</font>
				</small>
				<img src="Atollic_220x220.jpg" style="width:220px; max-width:220px;" border="0">
				<br>
				<small>
					<font color="red">
						<b>&uArr; Free Download Without Registering &uArr;</b>
					</font>
				</small>
			</a>
			<p>
			<a href="https://www.highintegritysystems.com/safertos/" target="_blank">
				<img src="http://www.freertos.org/banner-images/WHIS_SafeRTOS.png" style="width:220px; max-width:220px;" border="0">
			</a>
			<p>
			<a href="Reliance_Edge_Fail_Safe_File_System.shtml" target="_blank" onclick="_gaq.push(['_trackEvent','Banner','Datalight_120x60',this.href,1,true]);">
				<img src="fail_safe_file_system_240x240.jpg" width="220px" style="border: 1px solid silver; max-width:220px;">
			</a>
			<p>
			<br>
			<small><b><u>FreeRTOS Partners</u></b></small>
			<p>
			<img src="http://www.freertos.org/FreeRTOS-partners/ARM-connected.png" alt="ARM Connected RTOS partner for all ARM microcontroller cores">
			<p>
			<a href="http://www.renesas.eu/" target="_blank"><img src="Renesas-Electronics-Gold-Alliance-Partner.jpg" border="0" alt="Renesas Electronics Gold Alliance RTOS Partner.jpg"></a>
			<p>
			<a href="http://www.microchip.com/" target="_blank"><img src="Microchip-Premier-Third-Party-Partner.jpg" border="0" alt="Microchip Premier RTOS Partner"></a>
			<p>
			<img src="Partner-of-NXP.jpg" alt="RTOS partner of NXP for all NXP ARM microcontrollers">
			<p>
			<img src="Atmel-logo.jpg" alt="Atmel RTOS partner supporting ARM Cortex-M3 and AVR32 microcontrollers">
			<p>
			<img src="STmicro-logo.jpg" alt="STMicro RTOS partner supporting ARM7, ARM Cortex-M3, ARM Cortex-M4 and ARM Cortex-M0">
			<p>
			<img src="Xilinx.jpg" alt="Xilinx Microblaze and Zynq partner">
			<p>
			<img src="http://www.freertos.org/FreeRTOS-partners/silicon-labs-logo.png" alt="Silicon Labs low power RTOS partner">
			<p>
			<img src="Altera.jpg" alt="Altera RTOS partner for Nios II and Cortex-A9 SoC">
			<p>
			<img src="Freescale-alliance-member.jpg" alt="Freescale Alliance RTOS Member supporting ARM and ColdFire microcontrollers">
			<p>
			<img src="http://www.freertos.org/FreeRTOS-partners/Infineon.png" alt="Infineon ARM Cortex-M microcontrollers">
			<p>
			<img src="Texas-Instruments-MCU-Developer-Network.jpg" alt="Texas Instruments MCU Developer Network RTOS partner for ARM and MSP430 microcontrollers">
			<p>
			<img src="Cypress-logo.jpg" alt="Cypress RTOS partner supporting ARM Cortex-M3">
			<p>
			<img src="http://www.freertos.org/FreeRTOS-partners/fujitsu.png" alt="Fujitsu RTOS partner supporting ARM Cortex-M3 and FM3">
			<p>
			<img src="microsemi.jpg" alt="Microsemi (previously Actel) RTOS partner supporting ARM Cortex-M3">
			<p>
			<a href="http://www.atollic.com" target="_blank"><img src="http://www.freertos.org/FreeRTOS-partners/Atollic.png" alt="Atollic Partner" border="0"></a>
			<p>
			<img src="IAR.jpg" alt="IAR Partner">
			<p>
			<img src="Keil.gif" alt="Keil ARM Partner">
			<p>
			<img src="Embedded-Artists.jpg" alt="Embedded Artists">
			<p>
		</td>
	</tr>
</table>
<script type="text/javascript" language="JavaScript"><!--
	document.getElementById('banner_div').innerHTML = show_banners2();
//--></script>


</body></html>
